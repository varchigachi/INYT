<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Universal Downloader</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #bar { animation: pulseGlow 2s infinite alternate ease-in-out; }
    @keyframes pulseGlow {
      from { box-shadow: 0 0 12px rgba(0,255,255,0.8), 0 0 24px rgba(0,150,255,0.4); }
      to { box-shadow: 0 0 24px rgba(0,255,255,0.9), 0 0 36px rgba(0,150,255,0.6); }
    }
  </style>
</head>
<body class="bg-[#0f172a] text-white flex flex-col items-center justify-center min-h-screen px-5">

  <h1 class="text-3xl font-bold text-cyan-400 mb-6">ğŸŒ Universal Downloader</h1>

  <!-- Tabs -->
  <div class="flex gap-2 mb-5">
    <button id="ytTab" class="tab-btn bg-cyan-500 text-black font-semibold px-4 py-2 rounded-xl shadow-md">YouTube</button>
    <button id="igTab" class="tab-btn bg-neutral-700 hover:bg-neutral-600 px-4 py-2 rounded-xl">Instagram</button>
  </div>

  <!-- Form -->
  <form class="flex flex-col items-center gap-3 w-full max-w-md">
    <input id="urlInput" type="text" placeholder="Paste video URL"
      class="w-full p-3 rounded-xl bg-neutral-800 border border-neutral-700 text-gray-200 focus:ring-2 focus:ring-cyan-400 outline-none" />
    <button type="submit"
      class="w-full bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-500 text-black font-semibold py-2 rounded-xl shadow-md hover:opacity-90 transition">
      ğŸ” Fetch Details
    </button>
  </form>

  <div id="msg" class="mt-6 text-center text-gray-300"></div>

  <!-- Progress -->
  <div id="progressWrapper" class="w-full bg-neutral-800 h-3 rounded-2xl mt-6 relative overflow-hidden max-w-md">
    <div id="bar" class="h-3 w-0 bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-500 rounded-2xl transition-all duration-500 ease-out"></div>
    <span id="pct" class="absolute right-3 top-[-28px] text-sm text-gray-300 font-semibold">0%</span>
  </div>

  <div id="toast" class="hidden fixed bottom-6 right-6 z-50 px-5 py-4 rounded-xl text-lg font-semibold shadow-2xl"></div>

  <script>
    const form = document.querySelector("form");
    const msg = document.getElementById("msg");
    const bar = document.getElementById("bar");
    const pct = document.getElementById("pct");
    const toast = document.getElementById("toast");
    const ytTab = document.getElementById("ytTab");
    const igTab = document.getElementById("igTab");
    let currentPlatform = "youtube";
    let currentFileId = null;

    ytTab.onclick = () => switchTab("youtube");
    igTab.onclick = () => switchTab("instagram");

    function switchTab(tab) {
      currentPlatform = tab;
      if (tab === "youtube") {
        ytTab.className = "tab-btn bg-cyan-500 text-black font-semibold px-4 py-2 rounded-xl shadow-md";
        igTab.className = "tab-btn bg-neutral-700 hover:bg-neutral-600 px-4 py-2 rounded-xl";
      } else {
        igTab.className = "tab-btn bg-pink-500 text-black font-semibold px-4 py-2 rounded-xl shadow-md";
        ytTab.className = "tab-btn bg-neutral-700 hover:bg-neutral-600 px-4 py-2 rounded-xl";
      }
      msg.innerHTML = "";
      document.getElementById("urlInput").value = "";
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const url = document.getElementById("urlInput").value.trim();
      if (!url) return;
      msg.innerHTML = "â³ Fetching info...";
      bar.style.width = "10%";
      const formData = new FormData();
      formData.append("url", url);
      formData.append("platform", currentPlatform);

      try {
        const res = await fetch("/metadata", { method: "POST", body: formData });
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        msg.innerHTML = `
          <div class="mt-3 text-white text-center">
            <img src="${data.thumbnail}" class="rounded-xl mx-auto mb-3 w-64 border border-gray-700 shadow-lg">
            <h2 class="text-xl font-semibold">${data.title}</h2>
          </div>
          <div class="flex justify-center gap-3 mt-3">
            <button id="vidBtn" class="bg-blue-600 hover:bg-blue-700 transition px-3 py-2 rounded-xl shadow-md">ğŸ¥ Video</button>
            ${currentPlatform === "youtube" ? '<button id="audBtn" class="bg-green-600 hover:bg-green-700 transition px-3 py-2 rounded-xl shadow-md">ğŸ§ Audio</button>' : ""}
          </div>
        `;

        document.getElementById("vidBtn").onclick = () => startDownload(url, "video");
        if (currentPlatform === "youtube") {
          document.getElementById("audBtn").onclick = () => startDownload(url, "audio");
        }

        bar.style.width = "30%";
      } catch (err) {
        msg.innerHTML = `<span class="text-red-400">âŒ ${err.message}</span>`;
      }
    });

    async function startDownload(url, mode) {
      const formData = new FormData();
      formData.append("url", url);
      formData.append("platform", currentPlatform);
      formData.append("mode", mode);

      currentFileId = Date.now().toString();
      bar.style.width = "0%";
      pct.textContent = "0%";
      msg.innerHTML = "ğŸ“¥ Downloading...";

      pollProgress(currentFileId);

      try {
        const res = await fetch("/download", { method: "POST", body: formData });
        if (!res.ok) throw new Error("Download failed");
        const blob = await res.blob();
        const fileUrl = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = fileUrl;
        a.download = `${mode === "audio" ? "audio.mp3" : "video.mp4"}`;
        a.click();
        URL.revokeObjectURL(fileUrl);
        showToast("âœ… Download Complete!");
        bar.style.width = "100%";
        pct.textContent = "100%";
      } catch (err) {
        console.error(err);
        showToast("âŒ Download Failed", "error");
      } finally {
        currentFileId = null;
      }
    }

    async function pollProgress(id) {
      if (!id) return;
      const res = await fetch(`/progress/${id}`);
      const percent = await res.text();
      if (percent && percent !== "0%") {
        bar.style.width = percent;
        pct.textContent = percent;
      }
      if (percent !== "100%" && currentFileId === id) {
        setTimeout(() => pollProgress(id), 1000);
      }
    }

    function showToast(text, type = "success") {
      toast.textContent = text;
      toast.className = "fixed bottom-6 right-6 px-6 py-4 rounded-xl text-lg font-semibold shadow-2xl transform transition-all duration-500 ease-out";
      toast.classList.add(
        type === "error"
          ? "bg-gradient-to-r from-red-500 via-orange-500 to-pink-500 text-white"
          : "bg-gradient-to-r from-green-400 via-emerald-500 to-lime-400 text-black"
      );
      toast.classList.remove("hidden");
      toast.style.opacity = "1";
      setTimeout(() => (toast.style.opacity = "0"), 3000);
      setTimeout(() => toast.classList.add("hidden"), 3500);
    }
  </script>
</body>
</html>
